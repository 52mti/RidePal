<view class="chat-page">

  <!-- Scenario B: Back Arrow | Title | Right Icon -->
  <custom-nav
    title="{{chatTitle}}"
    show-back
    bg-color="#ededed"
    bind:back="goBack"
  />

  <!-- 蓝色公告卡片（动态类型显示） -->
  <view class="announcement" wx:if="{{isDynamic}}">
    <view class="announcement-header">
      <text class="announcement-label">公告：拼车动态</text>
      <text class="announcement-date">{{dynamicInfo.date}}</text>
    </view>
    <view class="announcement-body">
      <text class="announcement-text">车牌：{{dynamicInfo.plateNumber}} {{dynamicInfo.carColor}} {{dynamicInfo.carModel}}</text>
      <text class="announcement-text">{{dynamicInfo.route}}</text>
    </view>
  </view>

  <!-- 消息区域 -->
  <scroll-view
    class="scroll-box"
    scroll-y
    refresher-enabled="{{true}}"
    refresher-triggered="{{triggered}}"
    bindrefresherrefresh="onPullDownRefresh"
    scroll-into-view="{{toViewId}}"
    scroll-with-animation="{{false}}"
  >
    <view style="height: 20rpx;"></view>

    <block wx:for="{{messages}}" wx:key="id">
      <!-- 时间戳 -->
      <view class="time-stamp" wx:if="{{item.showTime}}">
        <text class="time-stamp-text">{{item.displayTime}}</text>
      </view>

      <!-- 消息行 -->
      <view id="msg-{{item.id}}" class="msg-row {{item.isMe ? 'msg-me' : 'msg-other'}}">
        <image class="avatar" src="{{item.avatar}}"></image>
        <view class="bubble {{item.isMe ? 'bubble-me' : 'bubble-other'}}">
          <text wx:if="{{item.type === 'text'}}">{{item.content}}</text>
          <image
            wx:if="{{item.type === 'image'}}"
            src="{{item.content}}"
            class="bubble-image"
            mode="widthFix"
            bindtap="previewImg"
            data-src="{{item.content}}"
          ></image>
        </view>
      </view>
    </block>

    <view style="height: 140rpx;"></view>
    <view id="bottom-anchor"></view>
  </scroll-view>

  <!-- 底部输入栏 -->
  <view class="input-bar">
    <van-icon name="audio" size="26px" color="#7d7d7d" bind:click="onVoiceClick" custom-class="bar-icon" />
    <view class="input-wrap">
      <input
        class="input-field"
        value="{{inputValue}}"
        bindinput="onInput"
        placeholder="请输入消息..."
        placeholder-class="input-placeholder"
        confirm-type="send"
        bindconfirm="sendMessage"
      />
    </view>
    <van-icon name="smile-o" size="26px" color="#7d7d7d" bind:click="onEmojiClick" custom-class="bar-icon" />
    <van-icon name="photo-o" size="26px" color="#7d7d7d" bind:click="onImageClick" custom-class="bar-icon" />
    <van-icon name="add-o" size="26px" color="#7d7d7d" bind:click="onMoreClick" custom-class="bar-icon" />
  </view>

</view>
